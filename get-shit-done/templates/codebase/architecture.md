# 架构模板

`.planning/codebase/ARCHITECTURE.md` 的模板——捕获概念性代码组织。

**目的：** 从概念层面记录代码的组织方式。补充 STRUCTURE.md（显示物理文件位置）。

---

## 文件模板

```markdown
# 架构

**分析日期：** [YYYY-MM-DD]

## 模式概述

**整体：** [模式名称：例如，"单体 CLI"、"无服务器 API"、"全栈 MVC"]

**关键特征：**
- [特征 1：例如，"单个可执行文件"]
- [特征 2：例如，"无状态请求处理"]
- [特征 3：例如，"事件驱动"]

## 层级

[描述概念层级及其职责]

**[层级名称]：**
- 目的：[该层级做什么]
- 包含：[代码类型：例如，"路由处理器"、"业务逻辑"]
- 依赖：[它使用什么：例如，"仅数据层"]
- 被使用：[什么使用它：例如，"API 路由"]

**[层级名称]：**
- 目的：[该层级做什么]
- 包含：[代码类型]
- 依赖：[它使用什么]
- 被使用：[什么使用它]

## 数据流

[描述典型的请求/执行生命周期]

**[流程名称]（例如，"HTTP 请求"、"CLI 命令"、"事件处理"）：**

1. [入口点：例如，"用户运行命令"]
2. [处理步骤：例如，"路由器匹配路径"]
3. [处理步骤：例如，"控制器验证输入"]
4. [处理步骤：例如，"服务执行逻辑"]
5. [输出：例如，"返回响应"]

**状态管理：**
- [如何处理状态：例如，"无状态——无持久状态"、"每个请求数据库"、"内存缓存"]

## 关键抽象

[整个代码库中使用的核心概念/模式]

**[抽象名称]：**
- 目的：[它代表什么]
- 示例：[例如，"UserService、ProjectService"]
- 模式：[例如，"单例"、"工厂"、"存储库"]

**[抽象名称]：**
- 目的：[它代表什么]
- 示例：[具体示例]
- 模式：[使用的模式]

## 入口点

[执行开始的地方]

**[入口点]：**
- 位置：[简短：例如，"src/index.ts"、"API 网关触发器"]
- 触发器：[什么调用它：例如，"CLI 调用"、"HTTP 请求"]
- 职责：[它做什么：例如，"解析参数，路由到命令"]

## 错误处理

**策略：** [如何处理错误：例如，"异常冒泡到顶级处理器"、"每路由错误中间件"]

**模式：**
- [模式：例如，"控制器级别的 try/catch"]
- [模式：例如，"向用户返回错误代码"]

## 横切关注点

[影响多层的方面]

**日志记录：**
- [方法：例如，"Winston 记录器，每个请求注入"]

**验证：**
- [方法：例如，"API 边界的 Zod 模式"]

**身份验证：**
- [方法：例如，"受保护路由上的 JWT 中间件"]

---

*架构分析：[日期]*
*主要模式更改时更新*
```

<good_examples>
```markdown
# 架构

**分析日期：** 2025-01-20

## 模式概述

**整体：** 带有插件系统的 CLI 应用程序

**关键特征：**
- 带有子命令的单个可执行文件
- 基于插件的扩展性
- 基于文件的状态（无数据库）
- 同步执行模型

## 层级

**命令层：**
- 目的：解析用户输入并路由到适当的处理器
- 包含：命令定义、参数解析、帮助文本
- 位置：`src/commands/*.ts`
- 依赖：服务层的业务逻辑
- 被使用：CLI 入口点（`src/index.ts`）

**服务层：**
- 目的：核心业务逻辑
- 包含：FileService、TemplateService、InstallService
- 位置：`src/services/*.ts`
- 依赖：文件系统实用程序、外部工具
- 被使用：命令处理器

**实用程序层：**
- 目的：共享助手和抽象
- 包含：文件 I/O 包装器、路径解析、字符串格式化
- 位置：`src/utils/*.ts`
- 依赖：仅 Node.js 内置
- 被使用：服务层

## 数据流

**CLI 命令执行：**

1. 用户运行：`gsd new-project`
2. Commander 解析参数和标志
3. 调用命令处理器（`src/commands/new-project.ts`）
4. 处理器调用服务方法（`src/services/project.ts` → `create()`）
5. 服务读取模板、处理文件、写入输出
6. 结果记录到控制台
7. 进程以状态码退出

**状态管理：**
- 基于文件：所有状态位于 `.planning/` 目录中
- 无持久内存状态
- 每个命令执行都是独立的

## 关键抽象

**服务：**
- 目的：封装域的业务逻辑
- 示例：`src/services/file.ts`、`src/services/template.ts`、`src/services/project.ts`
- 模式：类似单例（作为模块导入，不实例化）

**命令：**
- 目的：CLI 命令定义
- 示例：`src/commands/new-project.ts`、`src/commands/plan-phase.ts`
- 模式：Commander.js 命令注册

**模板：**
- 目的：可重用的文档结构
- 示例：PROJECT.md、PLAN.md 模板
- 模式：带有替换变量的 Markdown 文件

## 入口点

**CLI 入口：**
- 位置：`src/index.ts`
- 触发器：用户运行 `gsd <command>`
- 职责：注册命令、解析参数、显示帮助

**命令：**
- 位置：`src/commands/*.ts`
- 触发器：来自 CLI 的匹配命令
- 职责：验证输入、调用服务、格式化输出

## 错误处理

**策略：** 抛出异常，在命令级别捕获、记录并退出

**模式：**
- 服务抛出带有描述性消息的 Error
- 命令处理器捕获、将错误记录到 stderr、exit(1)
- 执行前显示验证错误（快速失败）

## 横切关注点

**日志记录：**
- Console.log 用于正常输出
- Console.error 用于错误
- Chalk 用于彩色输出

**验证：**
- 用于配置文件解析的 Zod 模式
- 命令处理器中的手动验证
- 无效输入时快速失败

**文件操作：**
- fs-extra 之上的 FileService 抽象
- 操作前验证所有路径
- 原子写入（临时文件 + 重命名）

---

*架构分析：2025-01-20*
*主要模式更改时更新*
```
</good_examples>

<guidelines>
**什么属于 ARCHITECTURE.md：**
- 整体架构模式（单体、微服务、分层等）
- 概念层级及其关系
- 数据流/请求生命周期
- 关键抽象和模式
- 入口点
- 错误处理策略
- 横切关注点（日志、身份验证、验证）

**什么不属于这里：**
- 详尽的文件列表（那是 STRUCTURE.md）
- 技术选择（那是 STACK.md）
- 逐行代码演练（推迟到代码阅读）
- 特定功能的实现细节

**文件路径是受欢迎的：**
将文件路径作为抽象的具体示例包括在内。使用反引号格式：`src/services/user.ts`。这使得架构文档在规划时对 Claude 可操作。

**填充此模板时：**
- 阅读主要入口点（index、server、main）
- 通过阅读导入/依赖来识别层级
- 跟踪典型的请求/命令执行
- 注意重复模式（服务、控制器、存储库）
- 保持描述概念性，而不是机械性

**在以下情况下对阶段规划有用：**
- 添加新功能（它适合层级中的哪个位置？）
- 重构（理解当前模式）
- 识别添加代码的位置（哪一层处理 X？）
- 理解组件之间的依赖关系
</guidelines>
