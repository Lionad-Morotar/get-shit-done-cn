# 摘要模板

用于 `.planning/phases/XX-name/{phase}-{plan}-SUMMARY.md` 的模板 — 阶段完成文档。

---

## 文件模板

```markdown
---
phase: XX-name
plan: YY
subsystem: [主要类别：身份验证、支付、ui、api、数据库、基础设施、测试等]
tags: [可搜索的技术：jwt、stripe、react、postgres、prisma]

# 依赖图
requires:
  - phase: [此阶段依赖的先前阶段]
    provides: [该阶段构建的此阶段使用的内容]
provides:
  - [此阶段构建/交付的内容的项目符号列表]
affects: [需要此上下文的阶段名称或关键字列表]

# 技术跟踪
tech-stack:
  added: [此阶段添加的库/工具]
  patterns: [建立的架构/代码模式]

key-files:
  created: [创建的重要文件]
  modified: [修改的重要文件]

key-decisions:
  - "决策 1"
  - "决策 2"

patterns-established:
  - "模式 1：描述"
  - "模式 2：描述"

# 指标
duration: Xmin
completed: YYYY-MM-DD
---

# 阶段 [X]: [名称] 摘要

**[描述结果的有意义一句话 — 不是"阶段完成"或"实施完成"]**

## 性能

- **持续时间：** [时间]（例如，23 分钟、1小时 15分钟）
- **开始：** [ISO 时间戳]
- **完成：** [ISO 时间戳]
- **任务：** [已完成计数]
- **修改的文件：** [计数]

## 成就
- [最重要的结果]
- [第二个关键成就]
- [第三个（如果适用）]

## 任务提交

每个任务都是原子性提交的：

1. **任务 1：[任务名称]** - `abc123f`（feat/fix/test/refactor）
2. **任务 2：[任务名称]** - `def456g`（feat/fix/test/refactor）
3. **任务 3：[任务名称]** - `hij789k`（feat/fix/test/refactor）

**计划元数据：** `lmn012o`（docs：完成计划）

_注意：TDD 任务可能有多个提交（test → feat → refactor）_

## 创建/修改的文件
- `path/to/file.ts` - 功能
- `path/to/another.ts` - 功能

## 做出的决策
[带有简要理由的关键决策，或"无 - 按照规范遵循计划"]

## 偏离计划

[如果没有偏离："无 - 计划完全按照书面执行"]

[如果发生偏离：]

### 自动修复的问题

**1. [规则 X - 类别] 简要描述**
- **发现于：** 任务 [N]（[任务名称]）
- **问题：** [什么错了]
- **修复：** [做了什么]
- **修改的文件：** [文件路径]
- **验证：** [如何验证]
- **提交于：** [hash]（任务提交的一部分）

[... 对每个自动修复重复 ...]

---

**总偏离：** [N] 个自动修复（[按规则分类]）
**对计划的影响：** [简要评估 - 例如，"所有自动修复对于正确性/安全性都是必需的。无范围蔓延。"]

## 遇到的问题
[问题和如何解决的，或"无"]

[注意："偏离计划"记录通过偏离规则自动处理的计划外工作。"遇到的问题"记录计划工作期间需要解决问题的问题。]

## 需要用户设置

[如果生成了 USER-SETUP.md：]
**外部服务需要手动配置。** 请参阅 [{phase}-USER-SETUP.md](./{phase}-USER-SETUP.md) 了解：
- 要添加的环境变量
- 控制台配置步骤
- 验证命令

[如果没有 USER-SETUP.md：]
无 - 不需要外部服务配置。

## 下一阶段就绪
[为下一阶段准备的内容]
[任何阻塞或问题]

---
*阶段：XX-name*
*完成时间：[日期]*
```

<frontmatter_guidance>
**目的：** 通过依赖图启用自动上下文组装。前置元数据使摘要元数据可被机器读取，以便 plan-phase 可以快速扫描所有摘要并根据依赖性选择相关摘要。

**快速扫描：** 前置元数据是前 ~25 行，可以在所有摘要中廉价扫描而无需读取完整内容。

**依赖图：** `requires`/`provides`/`affects` 在阶段之间创建显式链接，为上下文选择启用传递闭包。

**Subsystem：** 主要分类（身份验证、支付、ui、api、数据库、基础设施、测试）用于检测相关阶段。

**Tags：** 可搜索的技术关键字（库、框架、工具）用于技术栈意识。

**Key-files：** PLAN.md 中 @context 引用的重要文件。

**Patterns：** 未来阶段应保持的既定约定。

**填充：** 前置元数据在 execute-plan.md 中的摘要创建期间填充。有关逐字段指导，请参阅 `<step name="create_summary">`。
</frontmatter_guidance>

<one_liner_rules>
一句话必须是有意义的：

**好的：**
- "使用 jose 库的刷新轮换 JWT 身份验证"
- "具有 User、Session 和 Product 模型的 Prisma 架构"
- "通过 Server-Sent Events 实现实时指标的仪表板"

**不好的：**
- "阶段完成"
- "已实施身份验证"
- "基础完成"
- "所有任务完成"

一句话应该告诉人们实际交付的内容。
</one_liner_rules>

<example>
```markdown
# 阶段 1：基础摘要

**使用 jose 库的刷新轮换 JWT 身份验证、Prisma User 模型和受保护的 API 中间件**

## 性能

- **持续时间：** 28 分钟
- **开始：** 2025-01-15T14:22:10Z
- **完成：** 2025-01-15T14:50:33Z
- **任务：** 5
- **修改的文件：** 8

## 成就
- 带有电子邮件/密码身份验证的用户模型
- 带有 httpOnly JWT cookie 的登录/注销端点
- 检查令牌有效性的受保护路由中间件
- 每个请求上的刷新令牌轮换

## 创建/修改的文件
- `prisma/schema.prisma` - User 和 Session 模型
- `src/app/api/auth/login/route.ts` - 登录端点
- `src/app/api/auth/logout/route.ts` - 注销端点
- `src/middleware.ts` - 受保护路由检查
- `src/lib/auth.ts` - 使用 jose 的 JWT 辅助

## 做出的决策
- 使用 jose 而不是 jsonwebtoken（ESM 原生、Edge 兼容）
- 15 分钟访问令牌，7 天刷新令牌
- 在数据库中存储刷新令牌以实现撤销功能

## 偏离计划

### 自动修复的问题

**1. [规则 2 - 缺少关键] 使用 bcrypt 添加密码哈希**
- **发现于：** 任务 2（登录端点实施）
- **问题：** 计划未指定密码哈希 - 存储明文将是关键安全缺陷
- **修复：** 在注册时添加 bcrypt 哈希，登录时比较，盐轮数为 10
- **修改的文件：** src/app/api/auth/login/route.ts, src/lib/auth.ts
- **验证：** 密码哈希测试通过，从不存储明文
- **提交于：** abc123f（任务 2 提交）

**2. [规则 3 - 阻塞] 安装缺少的 jose 依赖**
- **发现于：** 任务 4（JWT 令牌生成）
- **问题：** jose 包不在 package.json 中，导入失败
- **修复：** 运行 `npm install jose`
- **修改的文件：** package.json, package-lock.json
- **验证：** 导入成功，构建通过
- **提交于：** def456g（任务 4 提交）

---

**总偏离：** 2 个自动修复（1 个缺少关键，1 个阻塞）
**对计划的影响：** 两个自动修复对于安全性和功能都是必需的。无范围蔓延。

## 遇到的问题
- jsonwebtoken CommonJS 导入在 Edge 运行时失败 - 切换到 jose（计划的库更改，按预期工作）

## 下一阶段就绪
- 身份验证基础完成，准备好功能开发
- 公开发布前需要用户注册端点

---
*阶段：01-foundation*
*完成时间：2025-01-15*
```
</example>

<guidelines>
**前置元数据：** 强制性 - 完成所有字段。为未来规划启用自动上下文组装。

**一句话：** 必须有意义。"使用 jose 库的刷新轮换 JWT 身份验证"而不是"已实施身份验证"。

**决策部分：**
- 执行期间做出的关键决策及理由
- 提取到 STATE.md 累积上下文
- 如果没有偏离，使用"无 - 按照规范遵循计划"

**创建后：** 使用位置、决策、问题更新 STATE.md。
</guidelines>
